#!/bin/sh

# Set environment variable dir
rm -rf /etc/envvars
mkdir /etc/envvars
env -u PWD -u HOME -u TERM -u OLDPWD -u _ \
    | awk -F'=' '{ $2 > "/etc/envvars/"$1 }'

run_script() {
    local file=$1

    if test -x "${file}"
    then
    	echo >&2 "- running ${file}"
    	($file) || (rc=$?; echo "${file} failed: ${rc}"; exit $rc)
    else
    	echo >&1 "- ${file} is not executable, skipping"
    fi
}

echo >&2 "- pre-init"

# Run pre-init scripts
for file in $(find /etc/runit_init.d -type f)
do
		run_script $file
done

if test -f /etc/rc.local && test -x /etc/rc.local
then
    run_script /etc/rc.local
fi

echo >&2 "- pre-init complete"

echo "starting /etc/service"
/sbin/runsvdir -P /etc/service &
runsvdir_pid=$!

trap "echo terminating on signal.. && kill $runsvdir_pid && wait $runsvdir_pid" SIGQUIT SIGINT SIGTERM SIGHUP
wait $runsvdir_pid